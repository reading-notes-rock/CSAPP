# 正文

## 6.1 存储技术

### 6.1.1 随机访问存储器(RAM，Random-Access Memory)

- 分类：动态(DRAM)和静态(SRAM)
  SRAM 比 DRAM 更快，也更贵
  SRAM 用做高速缓存存储器
  DRAM 用做主存以及图形系统的帧缓冲区

  #### 1.静态 RAM

  - SRAM 将每个位存储在一个双稳态的存储器单元里。每个单元是用一个六晶体管电路实现的。
  - 由于双稳态特性，只要有点，就会永远保持它的值。

  #### 2.动态 RAM

  - 对每个位存储为对一个电容的充电。
  - 对干扰非常敏感，当电容的电压被扰乱之后，它就永远不会恢复了。
  - 二者区别

    |      | 每位晶体管数 | 相对访问时间 | 持续的？ | 敏感的？ | 相对花费 |      应用      |
    | :--: | :----------: | :----------: | :------: | :------: | :------: | :------------: |
    | SRAM |      6       |      1x      |    是    |    否    |  1000x   | 高速缓存存储器 |
    | DRAM |      1       |     10x      |    否    |    是    |    1x    | 主存，帧缓冲区 |

  #### 3.传统的 DRAM

  - DRAM 芯片中的位被分成 d 个超单元，每个超单元都由 w 个 DRAM 单元组成。一个 d\*w 的 DRAM 总共存储了 dw 位的信息。

  - 超单元被组织成一个 r 行 c 列的长方形阵列，rc=d
  - 每个 DRAM 芯片被链接到某个称为内存控制器的电路

  #### 4.内存模块

  - DRAM 芯片封装在内存模块中，查到主板的扩展槽上。

  #### 5.增强的 DRAM

  - 快页模式 DRAM(Fast Page Mode DRAM,FPM DRAM)：传统的 DRAM 将超单元的一整行复制到它的内部行缓冲区中，使用一个，然后丢弃剩余的。FPM DRAM 允许对同一行连续的访问块也直接从行缓冲区得到服务。
  - 扩展数据输出 DRAM(Extended Data Out DRAM,EDO DRAM)：FPM DRAM 的一个增强的形式
  - 同步 DRAM(Synchronous DRAM,SDRAM)：常规的、FPM、EDO DRAM 都是异步的。SDRAM 比异步的存储器更快地输出它的超单元内容。
  - 双倍数据速率同步 DRAM(Double Data Rate Synchronous DRAM,DDR SDRAM)：对 SDRAM 的一种增强，通过两个时钟沿作为控制信号，从而使 DRAM 速度翻倍。
  - 视频 RAM(Video RAM, VRAM)：用在图形系统的帧缓冲区中。

  #### 6.非易失性存储器

  - 断电之后，DRAM 和 SRAM 会丢失信息，属于 易失的。观点之后仍然保存信息的，属于非易失性存储器。
  - ROM-Read-Only Memory，一般都是只读存储器
  - PROM(Programmable ROM，可编程 ROM)只能被编程一次。
  - 可擦可写编程 ROM(Erasable Programmable ROM, EPROM)
  - 电子可擦除 PROM(Electrically Erasable PROM, EEPROM)：类似于 EPROM
  - 闪存(flash memory)是一类非易失性存储器，基于 EEPROM

  #### 7.访问主存

  - 数据流通过称为总线(bus)的共享电子电路在处理器和 DRAM 主存之间来来回回。
  - 总线事务(bus transaction)：每次 CPU 和主存之间的数据传送都是通过一系列步骤来完成的，这些步骤就是 总线事务。
  - 读事务：从主存 --> CPU，写事务：从 CPU --> 主存
  - 总线是一组并行的导线，系统总线和内存总线，能携带地址、数据和控制信号
  - movq A, %rax 地址 A 的内容被加载到寄存器 %rax 中。发起读事务。
    - CPU 将地址 A 放到系统总线上。I/O 桥将信号传递到内存总线。
    - 主存感觉到内存总线上的地址信号，从内存总线读地址，从 DRAM 中取出数据字，并将数据写到内存总线。I/O 桥将内存总线信号翻译成系统总线信号，然后沿着系统总线传递。
    - CPU 感觉到系统总线上的数据，从总线上读数据，并将数据复制到寄存器%rax。
  - movq %rax, A 寄存器%rax 的内容被写到地址 A，CPU 发起写事务
    - CPU 将地址放到系统总线上。内存从内存总线读出地址，并等待数据到达。
    - CPU 将%rax 中的数据字复制到系统总线。
    - 主存从内存总线读出数据字，并且将这些位存储到 DRAM 中

### 6.1.2 磁盘存储

- 从磁盘读信息的时间为毫秒级，比 DRAM 读慢了 10 万倍，比 SRAM 读慢了 100 万倍。

  - 1. 磁盘构造
       盘片、表面、主轴、磁道、扇区、间隙
  - 2. 磁盘容量
       最大容量：一个磁盘上可以记录的最大位数，由以下技术因素决定：
       - 记录密度(位/英寸)：磁道一英寸的段中可以放入的位数
       - 磁道密度(道/英寸)：从盘片中心出发，半径上一英寸的段内可以有的磁道数
       - 面密度(位/平方英寸)：记录密度与磁道密度的乘积
       - 公式：磁盘容量 = 字节数(/扇区) \* 平均扇区数(/磁道) \* 磁道数(/表面) \* 表面数(/盘片) \* 盘片数(/磁盘)
  - 3. 磁盘操作
       - 磁盘用读/写头来读写存储在磁性表面的位
       - 寻道：通过沿着半径轴前后移动传动臂，驱动器可以将读/写头定位在盘面上的任何磁道上
       - 磁盘以扇区大小的块来读写数据。对扇区的访问时间有三个主要的部分：寻道时间、旋转时间、传送时间
       - 寻道时间：为了读取某个目标扇区的内容，传动臂首先将读写头定位到包含目标扇区的磁道上。这个所需的时间称为寻道时间。
       - 旋转时间：读写头定位到期望的磁道，驱动器等待目标扇区的第一个位旋转到读写头下，这个时间为旋转时间。
       - 传送时间：依赖于旋转速度和每条磁道的扇区数目。
  - 4. 逻辑磁盘块
       - 磁盘控制器，维护逻辑块号和实际磁盘扇区之间的映射关系
  - 5. 链接 I/O 设备
       - 通过 I/O 总线连接
  - 6. 访问磁盘
       - 使用内存映射 I/O 的系统中，地址空间中有一块地址是为 I/O 设备通信保留的。每个这样的地址称为一个 I/O 端口。

### 6.1.3 固态硬盘(SSD)

- 基于闪存的存储技术
- 读 SSD 比写 快

### 6.1.4 存储技术趋势

- 不同的村粗技术有不同的价格和性能折中。
- 不同存储技术的价格和性能属性以截然不同的速率变化着。

## 6.2 局部性

- 局部性原理：一个编写良好的计算机程序常常倾向于引用邻近于其他最近引用过的数据项的数据项，或者最近引用过的数据项本身。
- 具有良好的时间局部性：被引用过一次的内存位置很可能在不远的将来再被多次引用。
- 具有良好的空间局部性：如果一个内存位置被引用了一次，那么程序很可能在不远的将来引用附近的一个内存位置。

### 6.2.1 对程序数据引用的局部性

- 判断一个程序是否有良好的局部性。

```C
int sumvec(int v[N])
{
  int i, sum = 0;
  for (i = 0;i < N; i++)
    sum += v[i];
  return sum;
}
```

> 变量 sum 在每次循环迭代中被引用一次，因此，具有好的时间局部性

> 因为 sum 是标量，对于 sum 来说，没有空间局部性

> 对于变量 v，有很好的空间局部性，但是时间局部性很差，因为每个元素只被访问一次。

### 6.2.2 取指令的局部性

- 对于上面程序，for 循环体里的指令是按照连续的内存顺序执行的，因此循环有良好的空间局部性。因为循环体会被执行多次，所以它也有很好的时间局部性。

### 6.2.3 局部性小结

- 评价程序中局部性的一些简单原则：

```
1.重复引用相同变量的程序具有良好的时间局部性
2.对于具有步长为K的引用模式的程序，步长越小， 空间局部性越好。 具有步长为l 的引用模式的程序有很好的空间局部性。 在内存中以大步长跳来跳去的程序空间局部性会很差。
3.对于取指令来说，循环有好的时间和空间局部性。 循环体越小，循环迭代次数越 多，局部性越好。
```

## 6.3 存储器层次结构

### 6.3.1 存储器层次结构中的缓存

- 存储器层次结构的中心思想：对于每个 k，位于 k 层的更快更小的存储设备作为位于 k+1 层的更大更慢的存储设备的缓存。

  - 缓存命中
    当程序需要第 k+1 层的某个数据对象 d 时，如果 d 刚好缓存在第 k 层中，就是缓存命中。
  - 缓存不命中
    如果 k 层中没有缓存数据对象 d，就是缓存不命中
  - 缓存不命中的种类
    如果 k 层缓存是空的，被称为 冷缓存，此类不命中称为 强制性不命中 或 冷不命中
    冲突不命中：因为严格的放置策略，导致的不命中。在冲突不命中的情况中，缓存足够大，能恶狗保存被引用的数据对象，但是因为这些对象会映射到同一个缓存块，缓存会一直不命中。
  - 缓存管理
    存储器层次结构的本质是，每一层存储设备都是较低一层的缓存。在每一层上，某种形式的逻辑必须管理缓存。

### 6.3.2 存储器层次结构概念小结

| 类型        | 缓存什么            | 被缓存在何处         | 延迟(周期数)  | 由谁管理       |
| :---------- | :------------------ | :------------------- | :------------ | :------------- |
| CPU 寄存器  | 4 字节字或 8 字节字 | 芯片上的 CPU 寄存器  | 0             | 编译器         |
| TLB         | 地址翻译            | 芯片上的 TLB         | 0             | 硬件 MMU       |
| L1 高速缓存 | 64 字节块           | 芯片上的 L1 高速缓存 | 4             | 硬件           |
| L2 高速缓存 | 64 字节快           | 芯片上的 L2 高速缓存 | 10            | 硬件           |
| L3 高速缓存 | 64 字节快           | 芯片上的 L3 高速缓存 | 50            | 硬件           |
| 虚拟内存    | 4KB 页              | 主存                 | 200           | 硬件 + OS      |
| 缓冲区缓存  | 部分文件            | 主存                 | 200           | OS             |
| 磁盘缓存    | 磁盘扇区            | 磁盘控制器           | 100 000       | 控制器固件     |
| 网络缓存    | 部分文件            | 本地磁盘             | 10 000 000    | NFS 客户       |
| 浏览器缓存  | Web 页              | 本地磁盘             | 10 000 000    | Web 浏览器     |
| Web 缓存    | Web 页              | 远程服务器磁盘       | 1 000 000 000 | Web 代理服务器 |

## 6.4 高速缓存存储器

- L1 高速缓存的访问速度几乎和寄存器一样快，大约 4 个时钟周期
- L2 高速缓存的访问速度大约 10 个时钟周期
- L3 高速缓存的访问速度大约 50 个时钟周期

### 6.4.1 通用的高速缓存存储器组织结构

### 6.4.2 直接映射高速缓存

### 6.4.3 组相联高速缓存

### 6.4.4 全相联高速缓存

### 6.4.5 有关写的问题

### 6.4.6 一个真实的高速缓存层次结构的解剖

### 6.4.7 高速缓存参数的性能影响

## 6.5 编写高速缓存友好的代码

- 局部性比较好的程序更容易有较低的不命中率
- 确保代码高速缓存友好的基本方法：

  > 让最常见的情况运行得快

  > 尽量减小每个循环内部的缓存不命中数量

  > 对局部变量的反复引用是好的

  > 步长为 1 的引用模式是好的

## 6.6 综合：高速缓存对程序性能的影响

### 6.6.1 存储器山

### 6.6.2 重新排列循环以提高空间局部性

### 在程序中利用局部性

## 6.7 小结
